<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hitung Nilai Gizi</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div
      class="bg-white shadow-lg rounded-lg p-6 w-full max-w-4xl grid md:grid-cols-2 gap-6"
    >
      <!-- Panel Input (kiri) -->
      <section>
        <h2 class="text-xl font-bold text-gray-800 mb-4">Hitung Nilai Gizi</h2>

        <!-- Pencarian makanan -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700"
            >Cari Makanan</label
          >
          <div class="flex gap-2">
            <input
              id="queryInput"
              type="text"
              class="flex-1 border rounded px-3 py-2"
              placeholder="contoh: beras, ayam"
            />
            <button
              id="searchBtn"
              class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"
            >
              Cari
            </button>
          </div>
          <div id="loadingSearch" class="text-sm text-gray-500 mt-2 hidden">
            üîÑ Sedang mencari data...
          </div>
        </div>

        <!-- Select makanan -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700"
            >Pilih Makanan</label
          >
          <select id="makananSelect" class="w-full border rounded px-3 py-2">
            <option value="">-- Pilih Makanan --</option>
          </select>
        </div>

        <!-- Input berat -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700"
            >Berat (gram)</label
          >
          <input
            type="number"
            id="beratInput"
            class="w-full border rounded px-3 py-2"
            placeholder="contoh: 100"
          />
        </div>

        <!-- Tombol hitung -->
        <button
          id="hitungBtn"
          class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700"
        >
          Hitung
        </button>
        <div id="loadingHitung" class="text-sm text-gray-500 mt-2 hidden">
          ‚öôÔ∏è Sedang menghitung...
        </div>
      </section>

      <!-- Panel Hasil Gizi (kanan) -->
      <section>
        <h2 class="text-xl font-bold text-gray-800 mb-4">Hasil Perhitungan</h2>
        <div id="hasilEmpty" class="text-gray-500">Belum ada perhitungan.</div>

        <div id="hasil" class="hidden grid grid-cols-1 gap-3">
          <div class="p-4 bg-indigo-50 rounded">
            <div class="text-xs text-gray-500">Kalori</div>
            <div id="hasilKalori" class="text-lg font-bold text-indigo-700">
              0 kcal
            </div>
          </div>
          <div class="p-4 bg-emerald-50 rounded">
            <div class="text-xs text-gray-500">Protein</div>
            <div id="hasilProtein" class="text-lg font-bold text-emerald-700">
              0 g
            </div>
          </div>
          <div class="p-4 bg-yellow-50 rounded">
            <div class="text-xs text-gray-500">Karbohidrat</div>
            <div id="hasilKarbo" class="text-lg font-bold text-yellow-700">
              0 g
            </div>
          </div>
          <div class="p-4 bg-pink-50 rounded">
            <div class="text-xs text-gray-500">Lemak</div>
            <div id="hasilLemak" class="text-lg font-bold text-pink-700">
              0 g
            </div>
          </div>
          <div class="p-4 bg-teal-50 rounded">
            <div class="text-xs text-gray-500">Serat</div>
            <div id="hasilSerat" class="text-lg font-bold text-teal-700">
              0 g
            </div>
          </div>
        </div>
      </section>
    </div>

    <script>
      const API_URL = "http://127.0.0.1:5501/public/dataset/tkpi.json"; // path dataset lokal

      const hasilEmpty = document.getElementById("hasilEmpty");
      const hasilWrap = document.getElementById("hasil");
      const outKalori = document.getElementById("hasilKalori");
      const outProtein = document.getElementById("hasilProtein");
      const outKarbo = document.getElementById("hasilKarbo");
      const outLemak = document.getElementById("hasilLemak");
      const outSerat = document.getElementById("hasilSerat");

      async function searchMakanan() {
        const q = document
          .getElementById("queryInput")
          .value.trim()
          .toLowerCase();
        if (!q) return alert("Isi kata kunci makanan!");
        document.getElementById("loadingSearch").classList.remove("hidden");

        try {
          const res = await fetch(API_URL);
          const data = await res.json();
          const hasil = data.filter((item) =>
            item["NAMA BAHAN MENTAH"].toLowerCase().includes(q)
          );
          const select = document.getElementById("makananSelect");
          select.innerHTML = "<option value=''>-- Pilih Makanan --</option>";

          if (hasil.length > 0) {
            hasil.forEach((item) => {
              const opt = document.createElement("option");
              opt.value = item["KODE BARU"];
              opt.textContent = item["NAMA BAHAN MENTAH"];
              select.appendChild(opt);
            });
            alert(
              "‚úÖ Pencarian berhasil, ditemukan " + hasil.length + " makanan."
            );
          } else {
            alert("‚ùå Tidak ada makanan yang cocok dengan kata kunci.");
          }
        } catch (err) {
          alert("‚ùå Gagal mengambil data TKPI: " + err.message);
        } finally {
          document.getElementById("loadingSearch").classList.add("hidden");
        }
      }

      document
        .getElementById("hitungBtn")
        .addEventListener("click", async () => {
          const id = document.getElementById("makananSelect").value;
          const berat = parseFloat(document.getElementById("beratInput").value);
          if (!id || !berat) return alert("Pilih makanan dan isi berat!");

          document.getElementById("loadingHitung").classList.remove("hidden");

          try {
            const res = await fetch(API_URL);
            const data = await res.json();
            const makanan = data.find((m) => m["KODE BARU"] === id);

            const faktor = berat / makanan["BDD"]; // biasanya 100 g
            const energi = makanan["ENERGI"] * faktor;
            const protein = makanan["PROTEIN"] * faktor;
            const karbo = makanan["KH"] * faktor;
            const lemak = makanan["LEMAK"] * faktor;
            const serat = makanan["SERAT"] ? makanan["SERAT"] * faktor : 0;

            outKalori.textContent = `${energi.toFixed(2)} kcal`;
            outProtein.textContent = `${protein.toFixed(2)} g`;
            outKarbo.textContent = `${karbo.toFixed(2)} g`;
            outLemak.textContent = `${lemak.toFixed(2)} g`;
            outSerat.textContent = `${serat.toFixed(2)} g`;

            hasilEmpty.classList.add("hidden");
            hasilWrap.classList.remove("hidden");

            alert("‚úÖ Perhitungan berhasil.");
          } catch (err) {
            alert("‚ùå Gagal menghitung dari TKPI JSON: " + err.message);
          } finally {
            document.getElementById("loadingHitung").classList.add("hidden");
          }
        });

      document
        .getElementById("searchBtn")
        .addEventListener("click", searchMakanan);
    </script>
  </body>
</html>
